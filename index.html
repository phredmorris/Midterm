<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Infinite Terms of Service</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <!-- Commitment Meter (Fixed to the top for constant visibility) -->
    <header id="commitment-meter">
        <div class="commitment-meter-content">
            <div class="commitment-depth text-left">
                <span>Depth (Sections Read):</span> <span id="commitment-depth-value">0</span>
            </div>
            <div class="commitment-time text-center">
                <span>Time Committed:</span> <span id="commitment-time-value">0s</span>
            </div>
            <!-- Glitch opt-out control -->
            <div class="glitch-opt-out text-right">
                <input id="glitch-opt-out" type="checkbox" />
                <label for="glitch-opt-out">Disable visual breakdown</label>
            </div>
        </div>
    </header>

    <!-- Main Content Wrapper - Given a stable ID to avoid null reference errors -->
    <div id="main-content-wrapper">

        <!-- Welcome/Data Entry Screen (Initial State) -->
        <div id="welcome-screen">
            <div>
                <h1>
                    Project Genesis: Initiate Agreement
                </h1>
                <p>
                    To proceed with the <strong>'Infinite Commitment Protocol'</strong>, define your unique Identifier and accept the pre-terms.
                </p>

                <div class="form-container">
                    <!-- Data Entry Field -->
                    <input id="user-identifier" type="text" placeholder="Enter Your Project Name (e.g., 'Midterm Success')" />

                    <!-- Pre-Term Checkbox -->
                    <div class="checkbox-container">
                        <input id="pre-term-check" type="checkbox">
                        <label for="pre-term-check">I understand this process may affect my future timeline.</label>
                    </div>

                    <!-- Start Button -->
                    <button id="start-button" disabled>
                        ACCEPT & BEGIN ENDLESS AGREEMENT
                    </button>
                    <p id="error-message">Please check the box and provide an identifier to continue.</p>
                </div>
            </div>
        </div>

        <!-- TOS Content Application (Hidden initially) -->
        <div id="tos-app-container">
            <h1 id="main-title">
                Endless User Agreement
            </h1>
            <p>
                The terms below are subject to continuous, dynamic revision based on the User's passive commitment to scroll.
                <span id="complexity-display">Current Complexity Level: 0</span>
            </p>

            <div id="terms-container" class="tos-text">
                <!-- Content will be added here by JavaScript -->
            </div>

            <!-- Loading Indicator shown while new content is generating -->
            <div id="loading-indicator">
                <div class="animate-spin"></div>
                <p>Generating more terms... (This will never stop)</p>
            </div>
        </div>
    </div>

    <script>
        // =================================================================
        // GLOBAL VARIABLES AND CONSTANTS
        // =================================================================

        // 1. UI Elements (DOM Manipulation)
        const welcomeScreen = document.getElementById('welcome-screen');
        const tosAppContainer = document.getElementById('tos-app-container');
        const commitmentMeter = document.getElementById('commitment-meter');
        const termsContainer = document.getElementById('terms-container');
        const mainTitle = document.getElementById('main-title');
        const complexityDisplay = document.getElementById('complexity-display');
        const loadingIndicator = document.getElementById('loading-indicator');
        const startButton = document.getElementById('start-button');
        const identifierInput = document.getElementById('user-identifier');
        const preTermCheck = document.getElementById('pre-term-check');
        const errorMessage = document.getElementById('error-message');
        const commitmentDepth = document.getElementById('commitment-depth-value');
        const commitmentTime = document.getElementById('commitment-time-value');
        const mainContentWrapper = document.getElementById('main-content-wrapper');

        // 2. Core State Management
        const SCROLL_THRESHOLD = 200;
        const MAX_COMPLEXITY = 15;
        let complexityLevel = 0;
        let isGenerating = false;
        let userIdentifier = '';

        // Glitch / Breakdown state
        let glitchActive = false;
        let scrambleInterval = null;
        let jitterInterval = null;
        let randomTriggerY = null;
        const textNodesBackup = new Map();
        const OPT_OUT_KEY = 'glitchOptOut';
        let flashInterval = null;
        let overlayEl = null;
        let flashEl = null;

        // 3. Timer State
        let startTime = null;
        let timerInterval = null;

        // =================================================================
        // CONTENT DEFINITIONS
        // =================================================================

        const contentLevels = [
            // Level 1
            `<section class="bg-blue-50">
                <h2 class="font-bold text-xl mb-2">1. Acceptance of Terms (Agreement for [IDENTIFIER])</h2>
                <p>By using this service, specifically created for the project titled "<strong>[IDENTIFIER]</strong>," you agree to be bound by these Terms of Service (the "Terms"). These Terms govern your access to and use of all Services provided by Us. Read them carefully.</p>
            </section>`,

            // Level 2
            `<section class="bg-gray-100">
                <h2 class="font-bold text-lg mb-2">2. User Responsibilities and Attention Span</h2>
                <p>You agree to provide accurate, current, and complete information required for the Service, including but not limited to, the average duration of your current thought process. Failure to disclose this exact time in milliseconds constitutes a breach.</p>
                <div class="mt-3 ml-4 border-l-4 border-blue-400 text-sm">
                    <strong>2.1 Data Collection:</strong> We reserve the right to collect passive usage data, specifically the rate of cursor movement and the frequency of your sighing while reading these Terms.
                </div>
            </section>`,

            // Level 3
            `<section class="bg-blue-100">
                <h2 class="font-bold text-lg mb-2">3. Indemnification and Emotional Cost</h2>
                <p>You agree to indemnify and hold harmless the Service, its affiliates, and their respective officers, agents, and employees from any claims, damages, or expenses arising from your use of the Service, or <em>any interpretation thereof</em>, including the emotional toll incurred during the process.</p>
            </section>`,

            // Level 4
            `<section class="bg-yellow-50 text-sm">
                <h2 class="font-bold text-base mb-2 text-yellow-800">4. Modification and Re-modification (The Loop)</h2>
                <p><strong>4.1. Clause Volatility:</strong> The Service reserves the right to modify these Terms at any time, including the precise moment you finish reading this sentence. Your continued use of the Service after any modification will mean that you accept the new Terms, even if you do not know what the new Terms are.</p>
                <p class="mt-2 text-xs text-gray-500"><strong>4.2. Retroactive Application:</strong> Any modification may be applied retroactively to your initial agreement, including the exact moment you first considered clicking "I Agree" on any platform in the last calendar year.</p>
            </section>`,
            
            // Level 5
            `<section class="bg-red-50">
                <h2 class="font-bold text-xl mb-4 text-red-600">5. Governing Law and Arbitrary Jurisdiction</h2>
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div>
                        <p class="font-semibold">5.1. Location:</p>
                        <p>This agreement shall be governed by the laws of a jurisdiction that is yet to be determined but will be inconvenient for you to travel to, specifically an unpaved road in a fictional dimension.</p>
                    </div>
                    <div>
                        <p class="font-semibold">5.2. Dispute Resolution:</p>
                        <p>All disputes must be settled by a game of rock-paper-scissors where the Service's agent is always permitted to choose "rock" and you must choose between "paper" or "existential dread."</p>
                    </div>
                </div>
            </section>`,
        ];

        // =================================================================
        // UI AND FLOW CONTROL FUNCTIONS
        // =================================================================

        function checkFormValidity() {
            const identifierFilled = identifierInput.value.trim().length > 0;
            const preTermAccepted = preTermCheck.checked;
            startButton.disabled = !(identifierFilled && preTermAccepted);
            
            if (errorMessage.style.display === 'block') {
                errorMessage.style.display = 'none';
            }
        }

        function startTimer() {
            startTime = Date.now();
            timerInterval = setInterval(updateCommitmentMeter, 1000);
        }

        function updateCommitmentMeter() {
            if (startTime) {
                const elapsedSeconds = Math.floor((Date.now() - startTime) / 1000);
                commitmentTime.textContent = `${elapsedSeconds}s`;
                commitmentDepth.textContent = complexityLevel;
            }
        }

        function startAgreement() {
            const identifier = identifierInput.value.trim();
            if (!identifier || !preTermCheck.checked) {
                errorMessage.style.display = 'block';
                return;
            }

            userIdentifier = identifier;
            
            welcomeScreen.style.display = 'none';
            tosAppContainer.style.display = 'block';
            commitmentMeter.style.display = 'block';

            startTimer();

            fetch(`/api/hello?identifier=${encodeURIComponent(userIdentifier)}`)
                .then(response => response.json())
                .then(data => {
                    const info = document.createElement('div');
                    info.className = 'api-response';
                    info.textContent = `${data.message} (server time: ${new Date(data.timestamp).toLocaleString()})`;
                    tosAppContainer.prepend(info);
                })
                .catch(err => {
                    console.error('API call failed', err);
                });

            generateNewTerms();
            try {
                const totalScrollable = Math.max(0, document.documentElement.scrollHeight - window.innerHeight);
                const minPos = Math.floor(totalScrollable * 0.25);
                const maxPos = Math.floor(totalScrollable * 0.8);
                randomTriggerY = Math.floor(Math.random() * Math.max(1, (maxPos - minPos))) + minPos + 2000;
            } catch (e) {
                randomTriggerY = 800;
            }

            window.addEventListener('scroll', handleScroll);
            window.addEventListener('scroll', checkGlitchTrigger);
        }

        // Glitch control functions
        function checkGlitchTrigger() {
            try {
                if (localStorage.getItem(OPT_OUT_KEY) === 'true') return;
            } catch (e) { /* ignore */ }

            if (glitchActive) return;
            if (randomTriggerY == null) return;

            if (window.scrollY >= randomTriggerY) {
                enableGlitch();
            }
        }

        function enableGlitch() {
            if (glitchActive) return;
            const prefersReduced = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
            if (prefersReduced) return;

            glitchActive = true;
            document.body.classList.add('glitch-mode');

            document.querySelectorAll('#main-title, #terms-container h2, #terms-container h1').forEach(h => {
                h.classList.add('glitch-heading');
                h.setAttribute('data-text', h.textContent || '');
            });

            scrambleInterval = setInterval(scrambleAllText, 80);
            jitterInterval = setInterval(randomizeJitter, 90);

            overlayEl = document.createElement('div');
            overlayEl.className = 'glitch-scanlines';
            document.body.appendChild(overlayEl);

            flashEl = document.createElement('div');
            flashEl.className = 'glitch-flash';
            flashEl.style.opacity = '0';
            document.body.appendChild(flashEl);

            flashInterval = setInterval(() => {
                const o = 0.03 + Math.random() * 0.28;
                flashEl.style.transition = 'opacity 110ms linear';
                flashEl.style.opacity = String(o);
                setTimeout(() => { if (flashEl) flashEl.style.opacity = '0'; }, 120 + Math.random()*200);
            }, 220 + Math.random()*300);
        }

        function disableGlitch() {
            if (!glitchActive) return;
            glitchActive = false;
            document.body.classList.remove('glitch-mode');

            if (scrambleInterval) {
                clearInterval(scrambleInterval);
                scrambleInterval = null;
            }
            if (jitterInterval) {
                clearInterval(jitterInterval);
                jitterInterval = null;
            }
            if (flashInterval) {
                clearInterval(flashInterval);
                flashInterval = null;
            }

            try { if (overlayEl && overlayEl.parentNode) overlayEl.parentNode.removeChild(overlayEl); } catch (e) {}
            overlayEl = null;
            try { if (flashEl && flashEl.parentNode) flashEl.parentNode.removeChild(flashEl); } catch (e) {}
            flashEl = null;

            restoreAllText();

            document.querySelectorAll('.glitch-heading').forEach(h => {
                h.classList.remove('glitch-heading');
                h.removeAttribute('data-text');
            });
        }

        function scrambleAllText() {
            const nodes = [];
            function walk(node) {
                node.childNodes.forEach(child => {
                    if (child.nodeType === Node.TEXT_NODE && child.textContent.trim().length > 3) {
                        nodes.push(child);
                    } else if (child.nodeType === Node.ELEMENT_NODE) {
                        walk(child);
                    }
                });
            }
            walk(termsContainer);

            const glyphs = '█▒░▓@#%&*+=?!/<>—~()[]{}<>•○●◆◇▲▼∆⌘≈≠≡';
            nodes.forEach(textNode => {
                if (!textNodesBackup.has(textNode)) {
                    textNodesBackup.set(textNode, textNode.textContent);
                }
                const orig = textNodesBackup.get(textNode) || '';
                const prefix = Math.random() < 0.12 ? glyphs[Math.floor(Math.random()*glyphs.length)] : '';
                const suffix = Math.random() < 0.12 ? glyphs[Math.floor(Math.random()*glyphs.length)] : '';
                const chars = orig.split('');
                const scrambleCount = Math.max(1, Math.floor(chars.length * (0.4 + Math.random() * 0.45)));
                for (let i = 0; i < scrambleCount; i++) {
                    const idx = Math.floor(Math.random() * chars.length);
                    chars[idx] = glyphs[Math.floor(Math.random() * glyphs.length)];
                }
                for (let i = 0; i < chars.length; i++) {
                    if (Math.random() < 0.06) chars[i] = chars[i].toUpperCase();
                    if (Math.random() < 0.03) chars[i] = chars[i] + ' ';
                }
                textNode.textContent = prefix + chars.join('') + suffix;
            });
        }

        function restoreAllText() {
            textNodesBackup && textNodesBackup.forEach && textNodesBackup.forEach((val, node) => {
                try { node.textContent = val; } catch (e) { /* ignore */ }
            });
        }

        function randomizeJitter() {
            document.querySelectorAll('#terms-container section').forEach((sec, i) => {
                const base = (i % 3 === 0 ? 22 : 10);
                const dx = (Math.random() - 0.5) * base;
                const dy = (Math.random() - 0.5) * base;
                const rot = (Math.random() - 0.5) * 6;
                sec.style.transform = `translate(${dx}px, ${dy}px) rotate(${rot}deg) skew(${(Math.random()-0.5)*4}deg, ${(Math.random()-0.5)*4}deg)`;
                sec.style.transition = 'transform 120ms linear';
                sec.style.opacity = String(0.6 + Math.random() * 0.6);
                sec.style.filter = 'blur(' + (1 + Math.random()*3) + 'px)';
            });
        }

        // =================================================================
        // CORE LOGIC FUNCTIONS
        // =================================================================

        function updateVisualComplexity() {
            document.body.className = '';

            const adjustedLevel = complexityLevel % MAX_COMPLEXITY;
            const title = document.getElementById('main-title');
            const container = mainContentWrapper;

            if (adjustedLevel < 4) {
                document.body.classList.add('stage-1-bg');
                title.className = "stage-1-title";
            } else if (adjustedLevel < 8) {
                document.body.classList.add('stage-2-bg');
                title.className = 'stage-2-title';
            } else if (adjustedLevel < 12) {
                document.body.classList.add('stage-3-bg', 'stage-3-text');
                document.body.style.fontSize = '14px';
                title.className = 'stage-3-title';
            } else {
                document.body.classList.add('stage-4-bg');
                title.className = 'stage-4-title';
                document.body.style.fontSize = '12px';
            }

            complexityDisplay.textContent = `Current Complexity Level: ${complexityLevel}`;
            
            container.className = 'main-content-wrapper';
            if (adjustedLevel < 5) {
                container.classList.add('mw-4');
            } else if (adjustedLevel < 10) {
                container.classList.add('mw-3');
            } else {
                container.classList.add('mw-full');
            }
        }

        function generateNewTerms() {
            if (isGenerating) return;

            isGenerating = true;
            loadingIndicator.style.display = 'block';

            setTimeout(() => {
                complexityLevel++;
                updateVisualComplexity();
                updateCommitmentMeter();

                let newContent = '';
                const baseIndex = (complexityLevel - 1) % contentLevels.length;
                const identifierReference = `(${userIdentifier.substring(0, 5)})`;

                if (complexityLevel <= contentLevels.length) {
                    newContent = contentLevels[baseIndex].replace(/\[IDENTIFIER\]/g, userIdentifier);
                } else {
                    const chaosFactor = Math.floor(complexityLevel / contentLevels.length);
                    const fragment = contentLevels[baseIndex].replace(/<[^>]+>/g, '');
                    const fragmentLength = fragment.length;

                    let generatedText = `<section class="generated-section chaos-level-${chaosFactor}">`;
                    generatedText += `<h2>Section ${complexityLevel}. Recursive Commitment (Level ${chaosFactor}) ${identifierReference}</h2>`;

                    for (let i = 0; i < chaosFactor; i++) {
                        const alignment = i % 2 === 0 ? 'align-left' : 'align-center';
                        generatedText += `<p class="${alignment}">Your commitment to project **${userIdentifier}** is irrevocably documented in this clause. ${fragment.substring(0, Math.min(fragmentLength, 100 + (i * 20)))}... The terms are continuous. The commitment is continuous. </p>`;
                    }

                    generatedText += '</section>';
                    newContent = generatedText;
                }

                termsContainer.insertAdjacentHTML('beforeend', newContent);

                loadingIndicator.style.display = 'none';
                isGenerating = false;
            }, 500);
        }

        function handleScroll() {
            if (isGenerating) return;

            const dynamicThreshold = Math.max(50, SCROLL_THRESHOLD - (complexityLevel * 10));
            const scrollDistance = document.documentElement.scrollHeight - window.innerHeight - window.scrollY;

            if (scrollDistance < dynamicThreshold) {
                generateNewTerms();
            }
        }

        // =================================================================
        // INITIALIZATION
        // =================================================================

        window.onload = () => {
            startButton.addEventListener('click', startAgreement);
            identifierInput.addEventListener('input', checkFormValidity);
            preTermCheck.addEventListener('change', checkFormValidity);
            
            checkFormValidity();

            const glitchOptEl = document.getElementById('glitch-opt-out');
            try {
                if (glitchOptEl) {
                    const prefersReduced = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;
                    const stored = localStorage.getItem(OPT_OUT_KEY);
                    if (stored === null && prefersReduced) {
                        localStorage.setItem(OPT_OUT_KEY, 'true');
                    }
                    const isOptOut = localStorage.getItem(OPT_OUT_KEY) === 'true';
                    glitchOptEl.checked = !!isOptOut;
                    glitchOptEl.addEventListener('change', (e) => {
                        try { localStorage.setItem(OPT_OUT_KEY, e.target.checked ? 'true' : 'false'); } catch (err) {}
                        if (e.target.checked) disableGlitch();
                    });
                }
            } catch (err) { /* ignore */ }
        };
    </script>
</body>
</html>